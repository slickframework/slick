{{ '<?php'|raw }}

/**
 * {{ command.getControllerSimpleName }}
 *
 * @package {{ command.getNamespace|raw }}
 * @author  Your Name {{ '<your.name@email.com>'|raw }}
 * @license http://www.opensource.org/licenses/mit-license.php MIT License
 */

namespace {{ command.getNamespace }};

use {{ command.getModelName|raw }};
use Slick\Mvc\Controller,
    Slick\Mvc\Libs\Utils\Pagination,
    Slick\Mvc\Libs\Session\FlashMessages;

/**
 * {{ command.getControllerSimpleName }} controller
 *
 * @package {{ command.getNamespace|raw }}
 * @author  Your Name {{ '<your.name@email.com>'|raw }}
 */
class {{ command.getControllerSimpleName  }} extends Controller
{

{% block body %}
    /**
     * Handles the request to display index page
     */
    public function index()
    {
        $pagination = new Pagination();
        $options = array();
        $pagination->setTotal({{ command.getModelSimpleName }}::count($options));
        $options['limit'] = $pagination->rowsPerPage;
        $options['page'] = $pagination->offset;
        ${{ command.getModelPlural }} = {{ command.getModelSimpleName }}::all($options));
        $this->set(compact('{{ command.getModelPlural }}', 'pagination'));
    }

    /**
     * Handles the request to display the show page
     *
     * @param int $id The model primary key value
     */
    public function show($id = 0)
    {
        ${{ command.getModelSingular }} = {{ command.getModelSimpleName }}::get($id);
        if (!${{ command.getModelSingular }}) {
            $this->setMessage(
                FlashMessages::TYPE_WARNING,
                "The specified {{ command.getModelSingular }} does not exists."
            );
            $this->redirect('{{ command.getModelPlural }}/index');
        }
        $this->set(compact('{{ command.getModelSingular }}'));
    }

    /**
     * Handles the request to add a new {{ command.getModelSingular }}
     */
    public function add()
    {

        $form = new Form\{{ command.getFormName }}('add-{{ command.getModelSingular }}');

        if ($this->request->isPost()) {
            if ($form->isValid()) {
                ${{ command.getModelSingular }} = new {{ command.getModelSimpleName }}($form->getData());
                try {
                    ${{ command.getModelSingular }}->save();
                    $this->setMessage(
                        FlashMessages::TYPE_SUCCESS,
                        "{{ command.getModelSingular|capitalize }} successfully created."
                    );
                    $this->redirect(
                        '{{ command.getModelPlural }}/show/'.
                        ${{ command.getModelSingular }}->getConnector()->getLastInsertId()
                    );
                } catch (\Exception $exp) {
                    $this->setMessage(
                        FlashMessages::TYPE_WARNING,
                        "{{ command.getModelSingular|capitalize }} cannot be created. " . $exp->getMessage();
                    );
                }
            } else {
                $this->setMessage(
                    FlashMessages::TYPE_ERROR,
                    "{{ command.getModelSingular|capitalize }} cannot be created. Please check the errors below."
                );
            }
        }
        $this->set(compact('form'));
    }

{% endblock %}
}